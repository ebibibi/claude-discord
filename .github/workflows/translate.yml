name: Translate Documentation

on:
  push:
    branches: [main]
    paths:
      - "README.md"
      - "CONTRIBUTING.md"

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed
        run: |
          changed=$(git diff --name-only HEAD~1 HEAD -- README.md CONTRIBUTING.md)
          echo "files=$changed" >> "$GITHUB_OUTPUT"
          echo "Changed docs: $changed"

      - name: Translate documentation
        if: steps.changed.outputs.files != ''
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are a documentation translator for the claude-code-discord-bridge project.

            ## Task

            Check which English documentation files were updated by reading the git log:
            ```
            git diff --name-only HEAD~1 HEAD -- README.md CONTRIBUTING.md
            ```

            For each changed file, create or update its Japanese translation.

            ## Rules

            1. Create translated files in `docs/ja/` directory (create it if it doesn't exist)
            2. Keep all markdown formatting, code blocks, links, and badges intact
            3. Do NOT translate:
               - Code snippets and commands inside code blocks
               - URLs, file paths, and variable names
               - Project name "claude-code-discord-bridge"
               - Technical terms that are commonly used in English in the Japanese developer community (e.g., CLI, API, Cog, thread, session, subprocess)
               - Badge URLs and image references
            4. DO translate:
               - Headings, descriptions, and explanatory text
               - Table headers and descriptions (but not technical values)
               - Comments and notes
            5. Add a notice at the top of each translated file:
               ```
               > **Note:** This is an auto-translated version of the original English documentation.
               > If there are any discrepancies, the [English version](../../README.md) takes precedence.
               > この文書は英語版ドキュメントの自動翻訳です。内容に差異がある場合は英語版が優先されます。
               ```
            6. Preserve the same structure and section ordering as the original
            7. Use natural, fluent Japanese — not mechanical translation
            8. For README.md, update the relative link to CONTRIBUTING.md to point to the Japanese version

            ## Output

            Write the translated files to:
            - `docs/ja/README.md` (if README.md changed)
            - `docs/ja/CONTRIBUTING.md` (if CONTRIBUTING.md changed)

            After writing, verify the files are valid markdown.
          claude_args: "--allowedTools Read,Write,Edit,Bash --max-turns 15"
          timeout_minutes: 10
