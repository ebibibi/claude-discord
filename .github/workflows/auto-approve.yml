name: Auto Approve Owner PRs
on:
  pull_request:
    # ready_for_review: fires when a draft PR is converted to ready â€” this is
    # the intended trigger for multi-commit workflows where the PR is opened
    # as a draft, all commits are pushed, and then the PR is marked ready.
    types: [opened, synchronize, reopened, ready_for_review]
jobs:
  auto-approve-and-merge:
    # Skip draft PRs â€” only auto-merge when the PR is explicitly marked ready.
    # This prevents the race condition where auto-merge fires on the first
    # commit before subsequent commits have been pushed.
    if: github.event.pull_request.user.login == 'ebibibi' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Approve PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: gh pr review "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --approve
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: gh pr merge "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --auto --squash
      - name: Wait for merge and notify EbiBot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEBHOOK_URL: ${{ secrets.DOCS_SYNC_WEBHOOK_URL }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # GITHUB_TOKEN merges don't trigger other workflows (push/PR events).
          # So we poll for merge completion and send the webhooks directly.
          for i in $(seq 1 30); do
            STATE=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json state -q .state)
            if [ "$STATE" = "MERGED" ]; then
              echo "PR merged! Sending upgrade webhook..."
              curl -s -o /dev/null -w "%{http_code}" \
                -H "Content-Type: application/json" \
                -d '{"content":"ðŸ”„ ebibot-upgrade"}' \
                "$WEBHOOK_URL"

              # Send docs-sync webhook unless this is a docs-sync PR (prevent infinite loop).
              # HEAD_REF and PR_TITLE are passed via env: (safe â€” no direct interpolation in run:).
              if [[ "$HEAD_REF" != docs-sync/* ]] && [[ "$PR_TITLE" != '[docs-sync]'* ]]; then
                OPEN_PR=$(gh pr list \
                  --repo "$GITHUB_REPOSITORY" \
                  --state open \
                  --search "head:docs-sync/" \
                  --json number \
                  --limit 1)
                if [ "$(echo "$OPEN_PR" | jq length)" -eq 0 ]; then
                  echo "Sending docs-sync webhook..."
                  curl -s -o /dev/null -w "%{http_code}" \
                    -H "Content-Type: application/json" \
                    -d '{"content":"ðŸ”„ docs-sync"}' \
                    "$WEBHOOK_URL"
                else
                  echo "Skipping docs-sync: docs-sync PR already open"
                fi
              else
                echo "Skipping docs-sync: this is a docs-sync PR ($HEAD_REF)"
              fi

              exit 0
            fi
            echo "Waiting for merge... ($i/30)"
            sleep 10
          done
          echo "PR not merged within 5 minutes, skipping webhook"
